I"Ì-<h1 id="add-attendee-sign-up">Add attendee sign up</h1>
<p>In this section weâ€™ll add features that track attendees who have registered on the site and allow them to create a personal agenda.</p>

<h2 id="add-backend-attendee-and-frontend-user-association">Add BackEnd attendee and FrontEnd user association</h2>
<ol>
  <li>Update the <code class="language-plaintext highlighter-rouge">AuthHelpers</code> file in the <code class="language-plaintext highlighter-rouge">Infrastructure</code> folder, adding members to the <code class="language-plaintext highlighter-rouge">AuthConstants</code> and <code class="language-plaintext highlighter-rouge">AuthnHelpers</code> classes for working with attendee users:
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">namespace</span> <span class="nn">FrontEnd.Infrastructure</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">AuthConstants</span>
     <span class="p">{</span>
         <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">IsAdmin</span> <span class="p">=</span> <span class="k">nameof</span><span class="p">(</span><span class="n">IsAdmin</span><span class="p">);</span>
         <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">IsAttendee</span> <span class="p">=</span> <span class="k">nameof</span><span class="p">(</span><span class="n">IsAttendee</span><span class="p">);</span>
         <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">TrueValue</span> <span class="p">=</span> <span class="s">"true"</span><span class="p">;</span>
     <span class="p">}</span>
 <span class="p">}</span>

 <span class="k">namespace</span> <span class="nn">System.Security.Claims</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">AuthnHelpers</span>
     <span class="p">{</span>
         <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsAdmin</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsPrincipal</span> <span class="n">principal</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">principal</span><span class="p">.</span><span class="nf">HasClaim</span><span class="p">(</span><span class="n">AuthConstants</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">,</span> <span class="n">AuthConstants</span><span class="p">.</span><span class="n">TrueValue</span><span class="p">);</span>

         <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeAdmin</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsPrincipal</span> <span class="n">principal</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">principal</span><span class="p">.</span><span class="n">Identities</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="nf">MakeAdmin</span><span class="p">();</span>

         <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeAdmin</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsIdentity</span> <span class="n">identity</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">identity</span><span class="p">.</span><span class="nf">AddClaim</span><span class="p">(</span><span class="k">new</span> <span class="nf">Claim</span><span class="p">(</span><span class="n">AuthConstants</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">,</span> <span class="n">AuthConstants</span><span class="p">.</span><span class="n">TrueValue</span><span class="p">));</span>

         <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsAttendee</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsPrincipal</span> <span class="n">principal</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">principal</span><span class="p">.</span><span class="nf">HasClaim</span><span class="p">(</span><span class="n">AuthConstants</span><span class="p">.</span><span class="n">IsAttendee</span><span class="p">,</span> <span class="n">AuthConstants</span><span class="p">.</span><span class="n">TrueValue</span><span class="p">);</span>

         <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeAttendee</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsPrincipal</span> <span class="n">principal</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">principal</span><span class="p">.</span><span class="n">Identities</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="nf">MakeAttendee</span><span class="p">();</span>

         <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeAttendee</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsIdentity</span> <span class="n">identity</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">identity</span><span class="p">.</span><span class="nf">AddClaim</span><span class="p">(</span><span class="k">new</span> <span class="nf">Claim</span><span class="p">(</span><span class="n">AuthConstants</span><span class="p">.</span><span class="n">IsAttendee</span><span class="p">,</span> <span class="n">AuthConstants</span><span class="p">.</span><span class="n">TrueValue</span><span class="p">));</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Update the <code class="language-plaintext highlighter-rouge">ClaimsPrincipalFactory</code> class in the <code class="language-plaintext highlighter-rouge">Areas/Identity</code> folder and add code to <code class="language-plaintext highlighter-rouge">GenerateClaimsAsync</code> that adds the <code class="language-plaintext highlighter-rouge">IsAttendee</code> claim if the user is registered as an attendee:
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">class</span> <span class="nc">ClaimsPrincipalFactory</span> <span class="p">:</span> <span class="n">UserClaimsPrincipalFactory</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>
 <span class="p">{</span>
     <span class="k">private</span> <span class="k">readonly</span> <span class="n">IApiClient</span> <span class="n">_apiClient</span><span class="p">;</span>

     <span class="k">public</span> <span class="nf">ClaimsPrincipalFactory</span><span class="p">(</span><span class="n">IApiClient</span> <span class="n">apiClient</span><span class="p">,</span> <span class="n">UserManager</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">userManager</span><span class="p">,</span> <span class="n">IOptions</span><span class="p">&lt;</span><span class="n">IdentityOptions</span><span class="p">&gt;</span> <span class="n">optionsAccessor</span><span class="p">)</span>
         <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">userManager</span><span class="p">,</span> <span class="n">optionsAccessor</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">_apiClient</span> <span class="p">=</span> <span class="n">apiClient</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ClaimsIdentity</span><span class="p">&gt;</span> <span class="nf">GenerateClaimsAsync</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="kt">var</span> <span class="n">identity</span> <span class="p">=</span> <span class="k">await</span> <span class="k">base</span><span class="p">.</span><span class="nf">GenerateClaimsAsync</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="n">identity</span><span class="p">.</span><span class="nf">MakeAdmin</span><span class="p">();</span>
         <span class="p">}</span>

         <span class="kt">var</span> <span class="n">attendee</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetAttendeeAsync</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">UserName</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">attendee</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="n">identity</span><span class="p">.</span><span class="nf">MakeAttendee</span><span class="p">();</span>
         <span class="p">}</span>

         <span class="k">return</span> <span class="n">identity</span><span class="p">;</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Add a <code class="language-plaintext highlighter-rouge">Welcome.cshtml</code> Razor page and <code class="language-plaintext highlighter-rouge">Welcome.cshtml.cs</code> page model in the <code class="language-plaintext highlighter-rouge">Pages</code> folder.</li>
  <li>
    <p>Add a user sign up form to <code class="language-plaintext highlighter-rouge">Welcome.cshtml</code>:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> @page
 @using ConferenceDTO
 @model WelcomeModel

 <span class="nt">&lt;h2&gt;</span>Welcome @User.Identity.Name<span class="nt">&lt;/h2&gt;</span>
 <span class="nt">&lt;p&gt;</span>
     Register as an attendee to get access to cool features.
 <span class="nt">&lt;/p&gt;</span>

 <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">asp-validation-summary=</span><span class="s">"All"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/div&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Attendee.UserName"</span> <span class="na">value=</span><span class="s">"@User.Identity.Name"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;label</span> <span class="na">asp-for=</span><span class="s">"Attendee.FirstName"</span> <span class="na">class=</span><span class="s">"control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6"</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Attendee.FirstName"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="nt">/&gt;</span>
             <span class="nt">&lt;/div&gt;</span>
         <span class="nt">&lt;/div&gt;</span>
         <span class="nt">&lt;span</span> <span class="na">asp-validation-for=</span><span class="s">"Attendee.FirstName"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;label</span> <span class="na">asp-for=</span><span class="s">"Attendee.LastName"</span> <span class="na">class=</span><span class="s">"control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6"</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Attendee.LastName"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="nt">/&gt;</span>
             <span class="nt">&lt;/div&gt;</span>
         <span class="nt">&lt;/div&gt;</span>
         <span class="nt">&lt;span</span> <span class="na">asp-validation-for=</span><span class="s">"Attendee.LastName"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;label</span> <span class="na">asp-for=</span><span class="s">"Attendee.EmailAddress"</span> <span class="na">class=</span><span class="s">"control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-6"</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Attendee.EmailAddress"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="nt">/&gt;</span>
             <span class="nt">&lt;/div&gt;</span>
         <span class="nt">&lt;/div&gt;</span>
         <span class="nt">&lt;span</span> <span class="na">asp-validation-for=</span><span class="s">"Attendee.EmailAddress"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">""</span><span class="nt">&gt;</span>
             <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
         <span class="nt">&lt;/div&gt;</span>
     <span class="nt">&lt;/div&gt;</span>
 <span class="nt">&lt;/form&gt;</span>
 @section Scripts {
     <span class="nt">&lt;partial</span> <span class="na">name=</span><span class="s">"_ValidationScriptsPartial"</span> <span class="nt">/&gt;</span>
 }
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a <code class="language-plaintext highlighter-rouge">Models</code> folder under your pages folder, create a class called <code class="language-plaintext highlighter-rouge">Attendee.cs</code>, then create a class which adds display specific information for an attendee</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">using</span> <span class="nn">System.ComponentModel</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">System.ComponentModel.DataAnnotations</span><span class="p">;</span>

 <span class="k">namespace</span> <span class="nn">FrontEnd.Pages.Models</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="k">class</span> <span class="nc">Attendee</span> <span class="p">:</span> <span class="n">ConferenceDTO</span><span class="p">.</span><span class="n">Attendee</span>
     <span class="p">{</span>
         <span class="p">[</span><span class="nf">DisplayName</span><span class="p">(</span><span class="s">"First name"</span><span class="p">)]</span>
         <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="k">base</span><span class="p">.</span><span class="n">FirstName</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="k">base</span><span class="p">.</span><span class="n">FirstName</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>

         <span class="p">[</span><span class="nf">DisplayName</span><span class="p">(</span><span class="s">"Last name"</span><span class="p">)]</span>
         <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="k">base</span><span class="p">.</span><span class="n">LastName</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="k">base</span><span class="p">.</span><span class="n">LastName</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>

         <span class="p">[</span><span class="nf">DisplayName</span><span class="p">(</span><span class="s">"Email address"</span><span class="p">)]</span>
         <span class="p">[</span><span class="nf">DataType</span><span class="p">(</span><span class="n">DataType</span><span class="p">.</span><span class="n">EmailAddress</span><span class="p">)]</span>
         <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="n">EmailAddress</span> <span class="p">{</span> <span class="k">get</span> <span class="p">=&gt;</span> <span class="k">base</span><span class="p">.</span><span class="n">EmailAddress</span><span class="p">;</span> <span class="k">set</span> <span class="p">=&gt;</span> <span class="k">base</span><span class="p">.</span><span class="n">EmailAddress</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>In <code class="language-plaintext highlighter-rouge">Welcome.cshtml.cs</code>, add logic that associates the logged in user with an attendee:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">FrontEnd.Services</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">FrontEnd.Pages.Models</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Mvc.RazorPages</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">System.Security.Claims</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authentication</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Identity</span><span class="p">;</span>

 <span class="k">namespace</span> <span class="nn">FrontEnd.Pages</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="k">class</span> <span class="nc">WelcomeModel</span> <span class="p">:</span> <span class="n">PageModel</span>
     <span class="p">{</span>
         <span class="k">private</span> <span class="k">readonly</span> <span class="n">IApiClient</span> <span class="n">_apiClient</span><span class="p">;</span>

         <span class="k">public</span> <span class="nf">WelcomeModel</span><span class="p">(</span><span class="n">IApiClient</span> <span class="n">apiClient</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="n">_apiClient</span> <span class="p">=</span> <span class="n">apiClient</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="p">[</span><span class="n">BindProperty</span><span class="p">]</span>
         <span class="k">public</span> <span class="n">Attendee</span> <span class="n">Attendee</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

         <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">OnGet</span><span class="p">()</span>
         <span class="p">{</span>
             <span class="c1">// Redirect to home page if user is anonymous or already registered as attendee</span>
             <span class="kt">var</span> <span class="n">isAttendee</span> <span class="p">=</span> <span class="n">User</span><span class="p">.</span><span class="nf">IsAttendee</span><span class="p">();</span>

             <span class="k">if</span> <span class="p">(!</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span> <span class="p">||</span> <span class="n">isAttendee</span><span class="p">)</span>
             <span class="p">{</span>
                 <span class="k">return</span> <span class="nf">RedirectToPage</span><span class="p">(</span><span class="s">"/Index"</span><span class="p">);</span>
             <span class="p">}</span>

             <span class="k">return</span> <span class="nf">Page</span><span class="p">();</span>
         <span class="p">}</span>

         <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostAsync</span><span class="p">()</span>
         <span class="p">{</span>
             <span class="kt">var</span> <span class="n">success</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">AddAttendeeAsync</span><span class="p">(</span><span class="n">Attendee</span><span class="p">);</span>

             <span class="k">if</span> <span class="p">(!</span><span class="n">success</span><span class="p">)</span>
             <span class="p">{</span>
                 <span class="n">ModelState</span><span class="p">.</span><span class="nf">AddModelError</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="s">"There was an issue creating the attendee for this user."</span><span class="p">);</span>
                 <span class="k">return</span> <span class="nf">Page</span><span class="p">();</span>
             <span class="p">}</span>

             <span class="c1">// Re-issue the auth cookie with the new IsAttendee claim</span>
             <span class="n">User</span><span class="p">.</span><span class="nf">MakeAttendee</span><span class="p">();</span>
             <span class="k">await</span> <span class="n">HttpContext</span><span class="p">.</span><span class="nf">SignInAsync</span><span class="p">(</span><span class="n">IdentityConstants</span><span class="p">.</span><span class="n">ApplicationScheme</span><span class="p">,</span> <span class="n">User</span><span class="p">);</span>

             <span class="k">return</span> <span class="nf">RedirectToPage</span><span class="p">(</span><span class="s">"/Index"</span><span class="p">);</span>
         <span class="p">}</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Logged in users can now be associated with an attendee by visiting this page.</li>
</ol>

<h2 id="add-a-middleware-to-force-logged-in-users-to-sign-up-on-welcome-page">Add a middleware to force logged in users to sign up on welcome page</h2>
<ol>
  <li>Add a folder called <code class="language-plaintext highlighter-rouge">Middleware</code>.</li>
  <li>
    <p>Add a new attribute <code class="language-plaintext highlighter-rouge">SkipWelcomeAttribute.cs</code> to allow certain pages or action methods to be skipped from enforcing redirection to the Welcome page:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>

 <span class="k">namespace</span> <span class="nn">FrontEnd</span>
 <span class="p">{</span>
     <span class="p">[</span><span class="nf">AttributeUsage</span><span class="p">(</span><span class="n">AttributeTargets</span><span class="p">.</span><span class="n">Class</span> <span class="p">|</span> <span class="n">AttributeTargets</span><span class="p">.</span><span class="n">Method</span><span class="p">)]</span>
     <span class="k">public</span> <span class="k">class</span> <span class="nc">SkipWelcomeAttribute</span> <span class="p">:</span> <span class="n">Attribute</span>
     <span class="p">{</span>

     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a new class called <code class="language-plaintext highlighter-rouge">RequireLoginMiddleware.cs</code> that redirects to the Welcome page if the user is authenticated but not associated with an attendee (does not have the <code class="language-plaintext highlighter-rouge">"IsAttendee"</code> claim):</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">class</span> <span class="nc">RequireLoginMiddleware</span>
 <span class="p">{</span>
     <span class="k">private</span> <span class="k">readonly</span> <span class="n">RequestDelegate</span> <span class="n">_next</span><span class="p">;</span>
     <span class="k">private</span> <span class="k">readonly</span> <span class="n">LinkGenerator</span> <span class="n">_linkGenerator</span><span class="p">;</span>

     <span class="k">public</span> <span class="nf">RequireLoginMiddleware</span><span class="p">(</span><span class="n">RequestDelegate</span> <span class="n">next</span><span class="p">,</span> <span class="n">LinkGenerator</span> <span class="n">linkGenerator</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">_next</span> <span class="p">=</span> <span class="n">next</span><span class="p">;</span>
         <span class="n">_linkGenerator</span> <span class="p">=</span> <span class="n">linkGenerator</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="k">public</span> <span class="n">Task</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="kt">var</span> <span class="n">endpoint</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="nf">GetEndpoint</span><span class="p">();</span>

         <span class="c1">// If the user is authenticated but not a known attendee *and* we've not marked this page</span>
         <span class="c1">// to skip attendee welcome, then redirect to the Welcome page</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span> <span class="p">&amp;&amp;</span>
             <span class="n">endpoint</span><span class="p">?.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">GetMetadata</span><span class="p">&lt;</span><span class="n">SkipWelcomeAttribute</span><span class="p">&gt;()</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="kt">var</span> <span class="n">isAttendee</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="nf">IsAttendee</span><span class="p">();</span>

             <span class="k">if</span> <span class="p">(!</span><span class="n">isAttendee</span><span class="p">)</span>
             <span class="p">{</span>
                 <span class="kt">var</span> <span class="n">url</span> <span class="p">=</span> <span class="n">_linkGenerator</span><span class="p">.</span><span class="nf">GetUriByPage</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">page</span><span class="p">:</span> <span class="s">"/Welcome"</span><span class="p">);</span>
                 <span class="c1">// No attendee registerd for this user</span>
                 <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">Redirect</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>

                 <span class="k">return</span> <span class="n">Task</span><span class="p">.</span><span class="n">CompletedTask</span><span class="p">;</span>
             <span class="p">}</span>
         <span class="p">}</span>

         <span class="k">return</span> <span class="nf">_next</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the <code class="language-plaintext highlighter-rouge">RequireLoginMiddleware</code> in <code class="language-plaintext highlighter-rouge">Configure</code> method in <code class="language-plaintext highlighter-rouge">Startup.cs</code> before <code class="language-plaintext highlighter-rouge">UseEndpoints()</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">app</span><span class="p">.</span><span class="n">UseMiddleware</span><span class="p">&lt;</span><span class="n">RequireLoginMiddleware</span><span class="p">&gt;();</span>

 <span class="n">app</span><span class="p">.</span><span class="nf">UseEndpoints</span><span class="p">(</span><span class="n">endpoints</span> <span class="p">=&gt;</span>
 <span class="p">{</span>
     <span class="n">endpoints</span><span class="p">.</span><span class="nf">MapRazorPages</span><span class="p">();</span>
 <span class="p">});</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Update the <code class="language-plaintext highlighter-rouge">Welcome.cshtml.cs</code> class with the attribute to ensure it is skipped when the global filter runs:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[</span><span class="n">SkipWelcome</span><span class="p">]</span>
 <span class="k">public</span> <span class="k">class</span> <span class="nc">WelcomeModel</span> <span class="p">:</span> <span class="n">PageModel</span>
 <span class="p">{</span>
     <span class="p">...</span>
</code></pre></div>    </div>
  </li>
  <li>This should force all logged in users to register as an attendee.</li>
</ol>

<h2 id="scaffold-and-update-logout-page">Scaffold and update Logout page</h2>
<blockquote>
  <p>One problem with the above system is that if a new user creates an account but does not register as an attendee, they are unable to logout. The general solution to this is to add the <code class="language-plaintext highlighter-rouge">[SkipWelcome]</code> page to the <code class="language-plaintext highlighter-rouge">Logout</code> view, but in order to do that we will need to scaffold it. Identity pages are served from the Identity UI NuGet package by default, but can be added to a project and overridden, as we have already seen in the <code class="language-plaintext highlighter-rouge">Register</code> page.</p>
</blockquote>

<h3 id="using-visual-studio">Using Visual Studio</h3>
<ol>
  <li>Right-click on the <code class="language-plaintext highlighter-rouge">FrontEnd</code> project and select <em>Add</em> / <em>New Scaffolded Item</em> / <em>Identity</em>.</li>
  <li>Check the <code class="language-plaintext highlighter-rouge">Account\Logout</code> page, select the <code class="language-plaintext highlighter-rouge">IdentityDbContext</code> as the <em>Data context class</em>, and press <em>Add</em>.</li>
</ol>

<h3 id="using-command-line">Using command line</h3>
<ol>
  <li>Run this command from the <strong>FrontEnd</strong> project folder.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet aspnet-codegenerator identity --dbContext FrontEnd.Data.IdentityDbContext --files Account.Logout
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="next">Next</h3>
<ol>
  <li>Add the <code class="language-plaintext highlighter-rouge">[SkipWelcome]</code> attribute to the <code class="language-plaintext highlighter-rouge">LogoutModel</code> class:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[</span><span class="n">SkipWelcome</span><span class="p">]</span>
 <span class="p">[</span><span class="n">AllowAnonymous</span><span class="p">]</span>
 <span class="k">public</span> <span class="k">class</span> <span class="nc">LogoutModel</span> <span class="p">:</span> <span class="n">PageModel</span>
 <span class="p">{</span>
     <span class="p">...</span>
</code></pre></div>    </div>
  </li>
  <li>Youâ€™re now able to log out if you create a new user but donâ€™t register as an attendee.</li>
</ol>

<h1 id="add-personal-agenda">Add personal agenda</h1>

<h2 id="update-the-apiclient">Update the ApiClient</h2>
<ol>
  <li>
    <p>Add the following methods to <code class="language-plaintext highlighter-rouge">IApiClient</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">SessionResponse</span><span class="p">&gt;&gt;</span> <span class="nf">GetSessionsByAttendeeAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
 <span class="n">Task</span> <span class="nf">AddSessionToAttendeeAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sessionId</span><span class="p">);</span>
 <span class="n">Task</span> <span class="nf">RemoveSessionFromAttendeeAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sessionId</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the implementations to <code class="language-plaintext highlighter-rouge">ApiClient</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddSessionToAttendeeAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sessionId</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_httpClient</span><span class="p">.</span><span class="nf">PostAsync</span><span class="p">(</span><span class="s">$"/api/attendees/</span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s">/session/</span><span class="p">{</span><span class="n">sessionId</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>

     <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
 <span class="p">}</span>

 <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">RemoveSessionFromAttendeeAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sessionId</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_httpClient</span><span class="p">.</span><span class="nf">DeleteAsync</span><span class="p">(</span><span class="s">$"/api/attendees/</span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s">/session/</span><span class="p">{</span><span class="n">sessionId</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>

     <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>
 <span class="p">}</span>

 <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">SessionResponse</span><span class="p">&gt;&gt;</span> <span class="nf">GetSessionsByAttendeeAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_httpClient</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="s">$"/api/attendees/</span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s">/sessions"</span><span class="p">);</span>

     <span class="n">response</span><span class="p">.</span><span class="nf">EnsureSuccessStatusCode</span><span class="p">();</span>

     <span class="k">return</span> <span class="k">await</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="n">ReadAsAsync</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">SessionResponse</span><span class="p">&gt;&gt;();</span>
 <span class="p">}</span>
</code></pre></div>    </div>
    <h3 id="add-the-backend-api-to-get-sessions-by-an-attendee">Add the BackEnd API to get sessions by an attendee</h3>
  </li>
  <li>
    <p>Add an action called <code class="language-plaintext highlighter-rouge">GetSessions</code> to the <code class="language-plaintext highlighter-rouge">AttendeesController</code> in the <code class="language-plaintext highlighter-rouge">BackEnd</code> project:</p>
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[</span><span class="nf">HttpGet</span><span class="p">(</span><span class="s">"{username}/sessions"</span><span class="p">)]</span>
 <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ActionResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">SessionResponse</span><span class="p">&gt;&gt;&gt;</span> <span class="nf">GetSessions</span><span class="p">(</span><span class="kt">string</span> <span class="n">username</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="kt">var</span> <span class="n">sessions</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="n">Sessions</span><span class="p">.</span><span class="nf">AsNoTracking</span><span class="p">()</span>
                                         <span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Track</span><span class="p">)</span>
                                         <span class="p">.</span><span class="nf">Include</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">SessionSpeakers</span><span class="p">)</span>
                                             <span class="p">.</span><span class="nf">ThenInclude</span><span class="p">(</span><span class="n">ss</span> <span class="p">=&gt;</span> <span class="n">ss</span><span class="p">.</span><span class="n">Speaker</span><span class="p">)</span>
                                         <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">SessionAttendees</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">sa</span> <span class="p">=&gt;</span> <span class="n">sa</span><span class="p">.</span><span class="n">Attendee</span><span class="p">.</span><span class="n">UserName</span> <span class="p">==</span> <span class="n">username</span><span class="p">))</span>
                                         <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="nf">MapSessionResponse</span><span class="p">())</span>
                                         <span class="p">.</span><span class="nf">ToListAsync</span><span class="p">();</span>
     <span class="k">return</span> <span class="n">sessions</span><span class="p">;</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="add-addremove-to-personal-agenda-buttons-to-session-details-page">Add Add/Remove to personal agenda buttons to Session details page</h2>
<ol>
  <li>
    <p>Add a property <code class="language-plaintext highlighter-rouge">IsInPersonalAgenda</code> to <code class="language-plaintext highlighter-rouge">Session.cshtml.cs</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsInPersonalAgenda</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Compute the value of that property in <code class="language-plaintext highlighter-rouge">OnGetAsync</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="kt">var</span> <span class="n">sessions</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetSessionsByAttendeeAsync</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>

     <span class="n">IsInPersonalAgenda</span> <span class="p">=</span> <span class="n">sessions</span><span class="p">.</span><span class="nf">Any</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">Id</span> <span class="p">==</span> <span class="n">id</span><span class="p">);</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add a form to the bottom of <code class="language-plaintext highlighter-rouge">Session.cshtml</code> razor page that adds the ability to add/remove the session to the attendeeâ€™s personal agenda:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"sessionId"</span> <span class="na">value=</span><span class="s">"@Model.Session.Id"</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;p&gt;</span>
         <span class="nt">&lt;a</span> <span class="na">authz-policy=</span><span class="s">"Admin"</span> <span class="na">asp-page=</span><span class="s">"/Admin/EditSession"</span> <span class="na">asp-route-id=</span><span class="s">"@Model.Session.Id"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-sm"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>
         @if (Model.IsInPersonalAgenda)
         {
             <span class="nt">&lt;button</span> <span class="na">authz=</span><span class="s">"true"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">asp-page-handler=</span><span class="s">"Remove"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-sm"</span> <span class="na">title=</span><span class="s">"Remove from my personal agenda"</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon ion-md-star"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
             <span class="nt">&lt;/button&gt;</span>
         }
         else
         {
             <span class="nt">&lt;button</span> <span class="na">authz=</span><span class="s">"true"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-sm bg-transparent"</span> <span class="na">title=</span><span class="s">"Add to my personal agenda"</span><span class="nt">&gt;</span>
                 <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon ion-md-star-outline"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
             <span class="nt">&lt;/button&gt;</span>
         }
     <span class="nt">&lt;/p&gt;</span>
 <span class="nt">&lt;/form&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>The above markup uses a star icon from the <a href="https://ionicons.com/">ionicons</a>, one of the <a href="https://getbootstrap.com/docs/4.0/extend/icons/">icon libraries recommended by Bootstrap</a>. Letâ€™s add a CDN reference to this library in <code class="language-plaintext highlighter-rouge">Pages\Shared\_Layout.cshtml</code>, directly above the <code class="language-plaintext highlighter-rouge">site.css</code> reference:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;/environment&gt;</span>
 <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"https://unpkg.com/ionicons@4.5.5/dist/css/ionicons.min.css"</span> <span class="nt">/&gt;</span>
 <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"~/css/site.css"</span> <span class="nt">/&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add <code class="language-plaintext highlighter-rouge">OnPostAsync</code> handlers to <code class="language-plaintext highlighter-rouge">Session.cshtml.cs</code> that handles the adding/removing of the session to the personal agenda:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">sessionId</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">AddSessionToAttendeeAsync</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">sessionId</span><span class="p">);</span>

     <span class="k">return</span> <span class="nf">RedirectToPage</span><span class="p">();</span>
 <span class="p">}</span>

 <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostRemoveAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">sessionId</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">RemoveSessionFromAttendeeAsync</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">sessionId</span><span class="p">);</span>

     <span class="k">return</span> <span class="nf">RedirectToPage</span><span class="p">();</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Attendees should now be able to add/remove sessions to/from their personal agenda.</li>
</ol>

<h2 id="add-myagenda-page">Add MyAgenda page</h2>
<ol>
  <li>Add <code class="language-plaintext highlighter-rouge">MyAgenda.cshtml</code> and <code class="language-plaintext highlighter-rouge">MyAgenda.cshtml.cs</code> files to the <code class="language-plaintext highlighter-rouge">Pages</code> folder.</li>
  <li>The Index page and MyAgenda page share the vast majority of their logic and rendering. Weâ€™ll refactor the <code class="language-plaintext highlighter-rouge">Index.cshtml.cs</code> class so that it may be used as a base class for the <code class="language-plaintext highlighter-rouge">MyAgenda</code> page.</li>
  <li>
    <p>Add a <code class="language-plaintext highlighter-rouge">virtual</code> <code class="language-plaintext highlighter-rouge">GetSessionsAsync</code> method to <code class="language-plaintext highlighter-rouge">Index.cshtml.cs</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">protected</span> <span class="k">virtual</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">SessionResponse</span><span class="p">&gt;&gt;</span> <span class="nf">GetSessionsAsync</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="k">return</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetSessionsAsync</span><span class="p">();</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Change the <code class="language-plaintext highlighter-rouge">_apiClient</code> field in <code class="language-plaintext highlighter-rouge">Index.cshtml.cs</code> to be <code class="language-plaintext highlighter-rouge">protected</code> instead of <code class="language-plaintext highlighter-rouge">private</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">protected</span> <span class="k">readonly</span> <span class="n">IApiClient</span> <span class="n">_apiClient</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Change the logic in <code class="language-plaintext highlighter-rouge">OnGetAsync</code> to get session using the new virtual method we just added:</p>

    <p>Before</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">var</span> <span class="n">sessions</span> <span class="p">=</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetSessionsAsync</span><span class="p">();</span>
</code></pre></div>    </div>

    <p>After</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">var</span> <span class="n">sessions</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetSessionsAsync</span><span class="p">();</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Make the MyAgenda page model derive from the Index page model. Change <code class="language-plaintext highlighter-rouge">MyAgenda.cshtml.cs</code> to look like this:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">ConferenceDTO</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">FrontEnd.Services</span><span class="p">;</span>
 <span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authorization</span><span class="p">;</span>

 <span class="k">namespace</span> <span class="nn">FrontEnd.Pages</span>
 <span class="p">{</span>
     <span class="p">[</span><span class="n">Authorize</span><span class="p">]</span>
     <span class="k">public</span> <span class="k">class</span> <span class="nc">MyAgendaModel</span> <span class="p">:</span> <span class="n">IndexModel</span>
     <span class="p">{</span>
         <span class="k">public</span> <span class="nf">MyAgendaModel</span><span class="p">(</span><span class="n">IApiClient</span> <span class="n">client</span><span class="p">)</span>
             <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
         <span class="p">{</span>

         <span class="p">}</span>

         <span class="k">protected</span> <span class="k">override</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">SessionResponse</span><span class="p">&gt;&gt;</span> <span class="nf">GetSessionsAsync</span><span class="p">()</span>
         <span class="p">{</span>
             <span class="k">return</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetSessionsByAttendeeAsync</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
         <span class="p">}</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Refactor the <code class="language-plaintext highlighter-rouge">Index.cshtml</code> into a <code class="language-plaintext highlighter-rouge">_AgendaPartial.cshtml</code> under the <code class="language-plaintext highlighter-rouge">Pages\Shared</code> folder. It should have the following content:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> @model IndexModel

 <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"nav nav-pills mb-3"</span><span class="nt">&gt;</span>
 @foreach (var day in Model.DayOffsets)
 {
     <span class="nt">&lt;li</span> <span class="na">role=</span><span class="s">"presentation"</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link @(Model.CurrentDayOffset == day.Offset ? "</span><span class="na">active</span><span class="err">"</span> <span class="na">:</span> <span class="na">null</span><span class="err">)"</span> <span class="na">asp-route-day=</span><span class="s">"@day.Offset"</span><span class="nt">&gt;</span>@day.DayofWeek?.ToString()<span class="nt">&lt;/a&gt;</span>
     <span class="nt">&lt;/li&gt;</span>
 }
 <span class="nt">&lt;/ul&gt;</span>

 <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"agenda"</span><span class="nt">&gt;</span>
     @foreach (var timeSlot in Model.Sessions)
     {
         <span class="nt">&lt;h4&gt;</span>@timeSlot.Key?.ToString("HH:mm")<span class="nt">&lt;/h4&gt;</span>
         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
             @foreach (var session in timeSlot)
             {
                 <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-3 mb-4"</span><span class="nt">&gt;</span>
                     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card shadow session h-100"</span><span class="nt">&gt;</span>
                         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-header"</span><span class="nt">&gt;</span>@session.Track?.Name<span class="nt">&lt;/div&gt;</span>
                         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
                             <span class="nt">&lt;h5</span> <span class="na">class=</span><span class="s">"card-title"</span><span class="nt">&gt;&lt;a</span> <span class="na">asp-page=</span><span class="s">"Session"</span> <span class="na">asp-route-id=</span><span class="s">"@session.Id"</span><span class="nt">&gt;</span>@session.Title<span class="nt">&lt;/a&gt;&lt;/h5&gt;</span>
                         <span class="nt">&lt;/div&gt;</span>
                         <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer"</span><span class="nt">&gt;</span>
                             <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"list-inline mb-0"</span><span class="nt">&gt;</span>
                                 @foreach (var speaker in session.Speakers)
                                 {
                                     <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"list-inline-item"</span><span class="nt">&gt;</span>
                                         <span class="nt">&lt;a</span> <span class="na">asp-page=</span><span class="s">"Speaker"</span> <span class="na">asp-route-id=</span><span class="s">"@speaker.Id"</span><span class="nt">&gt;</span>@speaker.Name<span class="nt">&lt;/a&gt;</span>
                                     <span class="nt">&lt;/li&gt;</span>
                                 }
                             <span class="nt">&lt;/ul&gt;</span>
                             <span class="nt">&lt;form</span> <span class="na">authz</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
                             <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"sessionId"</span> <span class="na">value=</span><span class="s">"@session.Id"</span> <span class="nt">/&gt;</span>
                             <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"mb-0"</span><span class="nt">&gt;</span>
                                 <span class="nt">&lt;a</span> <span class="na">authz-policy=</span><span class="s">"Admin"</span> <span class="na">asp-page=</span><span class="s">"/Admin/EditSession"</span> <span class="na">asp-route-id=</span><span class="s">"@session.Id"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-xs"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>
                                 @if (Model.UserSessions.Contains(session.Id))
                                 {
                                     <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">asp-page-handler=</span><span class="s">"Remove"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-sm bg-transparent"</span> <span class="na">title=</span><span class="s">"Remove from my personal agenda"</span><span class="nt">&gt;</span>
                                         <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon ion-md-star"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
                                     <span class="nt">&lt;/button&gt;</span>
                                 }
                                 else
                                 {
                                     <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-sm bg-transparent"</span> <span class="na">title=</span><span class="s">"Add to my personal agenda"</span><span class="nt">&gt;</span>
                                         <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"icon ion-md-star-outline"</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;&lt;/i&gt;</span>
                                     <span class="nt">&lt;/button&gt;</span>
                                 }
                             <span class="nt">&lt;/p&gt;</span>
                             <span class="nt">&lt;/form&gt;</span>
                         <span class="nt">&lt;/div&gt;</span>
                     <span class="nt">&lt;/div&gt;</span>
                 <span class="nt">&lt;/div&gt;</span>
             }
         <span class="nt">&lt;/div&gt;</span>
     }
 <span class="nt">&lt;/div&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Update the <code class="language-plaintext highlighter-rouge">Index.cshtml</code> to use the new <code class="language-plaintext highlighter-rouge">_AgendaPartial</code>. Replace the entire div with the â€œagendaâ€ css class and replace it with the following:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"mb-4"</span><span class="nt">&gt;</span>My Conference @System.DateTime.Now.Year<span class="nt">&lt;/h1&gt;</span>

 <span class="nt">&lt;partial</span> <span class="na">name=</span><span class="s">"_AgendaPartial"</span> <span class="na">model=</span><span class="s">"Model"</span> <span class="nt">/&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Next, use the <code class="language-plaintext highlighter-rouge">_AgendaPartial</code> on the <code class="language-plaintext highlighter-rouge">MyAgenda.cshtml</code> page.
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> @page
 @model MyAgendaModel
 @{
     ViewData["Title"] = "My Agenda";
 }

 @if (Model.ShowMessage)
 {
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-success alert-dismissible"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"Close"</span><span class="nt">&gt;&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;&lt;/button&gt;</span>
         @Model.Message
     <span class="nt">&lt;/div&gt;</span>
 }

 <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"mb-4"</span><span class="nt">&gt;</span>My Agenda - My Conference @System.DateTime.Now.Year<span class="nt">&lt;/h1&gt;</span>

 <span class="nt">&lt;partial</span> <span class="na">name=</span><span class="s">"_AgendaPartial"</span> <span class="na">model=</span><span class="s">"Model"</span> <span class="nt">/&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="add-the-my-agenda-link-to-the-layout">Add the My Agenda link to the Layout</h2>
<ol>
  <li>Go to the layout file <code class="language-plaintext highlighter-rouge">_Layout.cshtml</code>.</li>
  <li>
    <p>Add a link that shows up only when authenticated under the <code class="language-plaintext highlighter-rouge">/Speakers</code> link:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;partial</span> <span class="na">name=</span><span class="s">"_LoginPartial"</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav flex-grow-1"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link text-dark"</span> <span class="na">asp-page=</span><span class="s">"/Search"</span><span class="nt">&gt;</span>Search<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link text-dark"</span> <span class="na">asp-area=</span><span class="s">""</span> <span class="na">asp-page=</span><span class="s">"/Index"</span><span class="nt">&gt;</span>Agenda<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link text-dark"</span> <span class="na">asp-page=</span><span class="s">"/Speakers"</span><span class="nt">&gt;</span>Speakers<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span> <span class="na">authz=</span><span class="s">"true"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link text-dark"</span> <span class="na">asp-page=</span><span class="s">"/MyAgenda"</span><span class="nt">&gt;</span>My Agenda<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link text-dark"</span> <span class="na">asp-area=</span><span class="s">""</span> <span class="na">asp-page=</span><span class="s">"/Privacy"</span><span class="nt">&gt;</span>Privacy<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
     <span class="nt">&lt;/ul&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="update-indexmodel-to-include-user-sessions">Update IndexModel to include User Sessions</h2>
<ol>
  <li>Add a <code class="language-plaintext highlighter-rouge">UserSessions</code> property to the <code class="language-plaintext highlighter-rouge">IndexModel</code>:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">UserSessions</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Update the <code class="language-plaintext highlighter-rouge">OnGet</code> method to fetch the <code class="language-plaintext highlighter-rouge">UserSessions</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnGet</span><span class="p">(</span><span class="kt">int</span> <span class="n">day</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">CurrentDayOffset</span> <span class="p">=</span> <span class="n">day</span><span class="p">;</span>

     <span class="k">if</span> <span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="kt">var</span> <span class="n">userSessions</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetSessionsByAttendeeAsync</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
         <span class="n">UserSessions</span> <span class="p">=</span> <span class="n">userSessions</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">u</span> <span class="p">=&gt;</span> <span class="n">u</span><span class="p">.</span><span class="n">Id</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>
     <span class="p">}</span>

     <span class="kt">var</span> <span class="n">sessions</span> <span class="p">=</span> <span class="k">await</span> <span class="nf">GetSessionsAsync</span><span class="p">();</span>
     <span class="c1">//...</span>
</code></pre></div>    </div>
  </li>
  <li>Add the following two methods to the <code class="language-plaintext highlighter-rouge">IndexModel</code> to handle adding and removing sessions from your agenda from the <code class="language-plaintext highlighter-rouge">Index</code> page:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">sessionId</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">AddSessionToAttendeeAsync</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">sessionId</span><span class="p">);</span>

     <span class="k">return</span> <span class="nf">RedirectToPage</span><span class="p">();</span>
 <span class="p">}</span>

 <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostRemoveAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">sessionId</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">RemoveSessionFromAttendeeAsync</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">sessionId</span><span class="p">);</span>

     <span class="k">return</span> <span class="nf">RedirectToPage</span><span class="p">();</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Run the application and test logging in and managing your agenda from the <code class="language-plaintext highlighter-rouge">Index</code> page, individual session details, and from the <code class="language-plaintext highlighter-rouge">My Agenda</code> page.</li>
</ol>

<hr />
<h2 id="sessions">Sessions</h2>

<p>This is series of articles on Building Conf planner app with Asp.net Core:</p>

<ul>
  <li><a href="/blog/CreateBackEndAPIproject" target="_blank">1 - Build the back-end API with basic EF model</a></li>
  <li><a href="/blog/BuildoutBackEndandRefactor" target="_blank">2 - Finish the back-end API and EF model, refactor into view modelsl</a></li>
  <li><a href="/blog/Addfront-endrenderagendasetupfront-endmodels" target="_blank">3 - Add front-end, render agenda, set up front-end models</a></li>
  <li><a href="/blog/Addauthfeatures" target="_blank">4 - Add authentication, add admin policy, allow editing sessions, users can sign-in with Identity, custom auth tag helper</a></li>
  <li><a href="/blog/Addpersonalagenda" target="_blank">5 - Add user association and personal agenda</a></li>
  <li><a href="/blog/ProductionReadinessandDeployment" target="_blank">6 - Deployment, Azure and other production environments, configuring environments, diagnostics</a></li>
  <li><a href="/blog/Challenges" target="_blank">7 - Challenges</a></li>
  <li><a href="/blog/SPAFrontEnd" target="_blank">8 - SPA front-end </a></li>
</ul>

<!--Section: Lesson UI-->
<section class="text-center">
    <hr />
   
    <div class="row">
        <div class="col-lg-4 col-md-6 col-sm-6">
            <a target="_blank" href="/blog/Addauthfeatures" class="btn  btn-sm" id="round-button">
                <i class="fas fa-arrow-left mr-2"></i>Previous Lesson
            </a>
        </div>
     
        <div class="col-lg-4 col-md-6 col-sm-6">
            <a target="_blank" href="/blog/ProductionReadinessandDeployment" class="btn btn-sm" id="round-button">Next Lesson
                <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>       
    </div>

</section>

:ET