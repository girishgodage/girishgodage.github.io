<!DOCTYPE html>
<html lang="en">

<head>
     
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Chrome, Firefox OS and Opera -->
<meta name="theme-color" content="#2A80EE">
<!-- Windows Phone -->
<meta name="msapplication-navbutton-color" content="#2A80EE">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-status-bar-style" content="#2A80EE">
<title>Add ability to log in to the website &#8211; Girish Godage</title>
<meta name="description" content="In this module we're going to add the capability for users to register and sign-in on the front-end web app with a username and password. We'll do this using ASP.NET Core Identity.">
<meta name="keywords" content="AspDotnetCore">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all">

<!-- Verifications -->
    
    
        
<!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Add ability to log in to the website">
    <meta property="og:description" content="I am a passionate Leader, who has a good command in technology &amp; Mangement. Also, I am a creative designer and an innovatie techie.">
    <meta property="og:url" content="http://localhost:4000/blog/Addauthfeatures">
    <meta property="og:site_name" content="Girish Godage">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    
        <meta name="twitter:site" content="@GGodage" />
    
    <meta name="twitter:title" content="Add ability to log in to the website" />
    <meta name="twitter:description" content="In this module we're going to add the capability for users to register and sign-in on the front-end web app with a username and password. We'll do this using ASP.NET Core Identity." />
    <meta name="twitter:url" content="http://localhost:4000/blog/Addauthfeatures" />

    <!-- Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/img/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/img/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="/img/favicon-192x192.png" sizes="192x192">
    <link rel="icon" type="image/png" href="/img/favicon-160x160.png" sizes="160x160">
    <link rel="icon" type="image/png" href="/img/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
    <link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
    


    <link rel="canonical" href="http://localhost:4000/blog/Addauthfeatures">
<link rel="alternate" type="application/rss+xml" title="RSS Feed for Girish Godage" href="/feed.xml" />
    <!-- Bootstrap CSS-->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <!-- Google fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Advent+Pro">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Varela+Round">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abel">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
   
    <!-- owl carousel-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/owl-carousel/1.3.3/owl.carousel.css" >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/owl-carousel/1.3.3/owl.theme.css">
    
    <!-- animate.css-->
    <link rel="stylesheet" href="http://localhost:4000/sitejs/animate.css/animate.css">
    <!-- theme stylesheet-->
    <!-- Custom stylesheet - for your changes-->
    <link rel="stylesheet" href="http://localhost:4000/css/custom.css" as="style">
    <link rel="stylesheet" href="http://localhost:4000/css/comments.css" as="style">
    <!-- Favicon-->
    <link rel="shortcut icon" href="http://localhost:4000/img/logo-big.png">
    <!-- Fab Icon-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-mfizz/2.4.1/font-mfizz.min.css">
    
    

    <!-- Global site tag (gtag.js) - Google Analytics -->
    
    <script type="text/javascript">
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
       ga('create', 'UA-130164763-2', 'auto');
       ga('send', 'pageview');
    </script>
    
    <!-- Typed.js DONT TOUCHHHHHHHHHHHHH!-->
    <!--<script src="https://cdn.rawgit.com/mattboldt/typed.js/master/lib/typed.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.9/typed.min.js"></script>
    <script>
        function copyToClipboard(element) {
            var $temp = $("<input>");
            $("body").append($temp);
            $temp.val($(element).text()).select();
            document.execCommand("copy");
            $temp.remove();
        }
      </script>
      
      <!-- START OF RELEVANT PART -->
    <script async src="https://just-comments.com/w2.js"></script>
    <!-- END OF RELEVANT PART -->


</head>

<body>
    
<!-- navbar-->
<header class="header">
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container"><a class="navbar-brand" href="http://localhost:4000"><img
          src="http://localhost:4000/img/logo-big.png" width="50" height="50" class="d-inline-block align-center"
          alt="logo"> <img src="http://localhost:4000/img/girish_logo.png" height="30" alt="girilogo"></a>
      <button type="button" data-toggle="collapse" data-target="#navbarcollapse" aria-controls="navbarSupportedContent"
        aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler navbar-toggler-right"><span
          class="fa fa-bars" style="color: white"></span></button>
      <div id="navbarcollapse" class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item"><a href="http://localhost:4000#home" class="nav-link  link-scroll">Home</a></li>
          <li class="nav-item"><a href="http://localhost:4000#about" class="nav-link link-scroll">About</a></li>
          <li class="nav-item"><a href="http://localhost:4000#skills" class="nav-link link-scroll">Skills</a>
          </li>
          <li class="nav-item"><a href="http://localhost:4000#services" class="nav-link link-scroll">Services</a>
          </li>
          <li class="nav-item"><a href="http://localhost:4000#references" class="nav-link link-scroll">My
              work</a></li>
          <li class="nav-item"><a href="http://localhost:4000#contact" class="nav-link link-scroll">Contact</a>
          </li>
          <li class="nav-item"><a href="http://localhost:4000/blog" class="nav-link link-scroll">Blog</a></li>
        </ul>
      </div>
    </div>
  </nav>
</header>

    
    
    
    <div style="background-color:Gray;">
        <div style="padding:0;min-height:95.05vh;display:flex;font-family: Poppins, sans-serif;margin-top: 5rem;"
            class="container">
            <div class="col-lg-12 col-md-12 col-sm-12">
                <p class="post-title">
                    <h1><a href="/blog/Addauthfeatures">Add ability to log in to the website</a></h1>
                </p>
                
                <span class="post-meta">
              <span style="font-weight:600">October 24, 2019 Thursday</span>
                    
                       ( 14 minute read ) 
                    
                     
                    <a style="font-weight:600" href="https://twitter.com/girishgodage_007" target="_blank">   by Girish Godage</a>
                </span>
                
                <div class="site-category"> 
                        <h5>AspDotnetCore</h5>
                </div>
                
                <hr>
                <div><img class="post-image" src="/img/aspnetcore.png" alt="Add ability to log in to the website" height="250" /></div>
                <div class="post-content">
                    <br>                     
                    <h1 id="add-ability-to-log-in-to-the-website">Add ability to log in to the website</h1>

<p>In this module we’re going to add the capability for users to register and sign-in on the front-end web app with a username and password. We’ll do this using ASP.NET Core Identity.</p>

<h2 id="scaffold-in-aspnet-core-identity-and-default-ui">Scaffold in ASP.NET Core Identity and Default UI</h2>
<blockquote>
  <p>We’ll start by scaffolding the default Identity experience into the front-end web app.</p>
</blockquote>

<h3 id="adding-identity-using-visual-studio">Adding Identity using Visual Studio</h3>
<ol>
  <li>Right-mouse click on the FrontEnd project in Solution Explorer and select “Add” and then “New Scaffolded Item…”
<img src="/img/aspdotnetcore/confplanner/5/60.png" alt="" /></li>
  <li>Select the “Identity” category from the left-hand menu and then select “Identity” from the list and click the “Add” button
<img src="/img/aspdotnetcore/confplanner/5/61.png" alt="" /></li>
  <li>In the “Add Identity” dialog, click the ‘+’ button to add a data context class. Call it <code class="highlighter-rouge">FrontEnd.Data.IdentityDbContext</code>.</li>
  <li>In the same dialog, click the ‘+’ button to add a user class. Call it <code class="highlighter-rouge">FrontEnd.Data.User</code>.
<img src="/img/aspdotnetcore/confplanner/5/64.png" alt="" /></li>
  <li>Click the “Add” button</li>
</ol>

<h3 id="adding-identity-using-the-command-line">Adding Identity using the Command Line</h3>
<ol>
  <li>Open a command line to the <strong>FrontEnd</strong> project folder</li>
  <li>If you haven’t done this already, install the command-line scaffolding tool.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet tool install -g dotnet-aspnet-codegenerator
</code></pre></div>    </div>
  </li>
  <li>Add the <code class="highlighter-rouge">Microsoft.VisualStudio.Web.CodeGeneration.Design</code> version <code class="highlighter-rouge">3.0.0</code> package to the project.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design --version 3.0.0
</code></pre></div>    </div>
  </li>
  <li>Run this command to generate the code to use Identity.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet aspnet-codegenerator identity --dbContext FrontEnd.Data.IdentityDbContext --userClass FrontEnd.Data.User --useDefaultUI
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="organize-the-newly-created-files">Organize the newly created files</h2>
<blockquote>
  <p>Note the new files added to the project in the “Areas/Identity” folder. We’re going to clean these up a little to better match this project’s conventions.</p>
</blockquote>

<ol>
  <li>Delete the <code class="highlighter-rouge">_ValidationScriptsPartial.cshtml</code> file in the <code class="highlighter-rouge">/Areas/Identity/Pages</code> folder, as we already have one in our project’s regular pages folder.</li>
  <li>Delete the <code class="highlighter-rouge">ScaffoldingReadme.txt</code> file.</li>
</ol>

<h2 id="add-the-identity-links-to-the-site-header">Add the Identity links to the site header</h2>
<blockquote>
  <p>The scaffolded out Identity system includes a Razor partial view that contains the Identity-related UI for the site header, e.g. Login and Register links, user name once logged in, etc. We need to add a call to this partial from our site’s own layout page:</p>
</blockquote>

<ol>
  <li>Open the <code class="highlighter-rouge">_Layout.cshtml</code> file and find the following line: <code class="highlighter-rouge">&lt;div class="navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"&gt;</code></li>
  <li>Immediately after this line, add a call to render the newly added <code class="highlighter-rouge">_LoginPartial.cshtml</code> using the <code class="highlighter-rouge">&lt;partial /&gt;</code> Tag Helper:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;partial</span> <span class="na">name=</span><span class="s">"_LoginPartial"</span> <span class="nt">/&gt;</span>
     <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav flex-grow-1"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link text-dark"</span> <span class="na">asp-area=</span><span class="s">""</span> <span class="na">asp-page=</span><span class="s">"/Index"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
     <span class="nt">&lt;/ul&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="update-the-app-to-support-admin-users">Update the app to support admin users</h2>
<blockquote>
  <p>Identity supports simple customization of the classes representing users, and when using the default Entity Framework Core, these changes will result in automatic schema updates for storage. We can also customize the default Identity UI by just scaffolding in the pages we want to change. Let’s add the ability to create an admin user.</p>
</blockquote>

<h3 id="customize-the-user-class-to-support-admin-users">Customize the <code class="highlighter-rouge">User</code> class to support admin users</h3>
<ol>
  <li>Open the newly created <code class="highlighter-rouge">User</code> class in the <code class="highlighter-rouge">/Areas/Identity/Data</code> folder</li>
  <li>Add a <code class="highlighter-rouge">bool</code> property called <code class="highlighter-rouge">IsAdmin</code> to indicate whether the user is an admin:
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">class</span> <span class="nc">User</span> <span class="p">:</span> <span class="n">IdentityUser</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAdmin</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="generate-the-entity-framework-migration-for-our-identity-schema">Generate the Entity Framework migration for our Identity schema</h3>

<h4 id="visual-studio-package-manager-console">Visual Studio: Package Manager Console</h4>

<ol>
  <li>
    <p>In Visual Studio, select the Tools -&gt; NuGet Package Manager -&gt; Package Manager Console</p>
  </li>
  <li>Run the following commands in the Package Manager Console
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Add-Migration CreateIdentitySchema
Update-Database
</span></code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/65.png" alt="" /></p>
    <h4 id="command-line">Command line</h4>
  </li>
  <li>Run the following commands in the command prompt:
    <div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go"> dotnet build
 dotnet ef migrations add CreateIdentitySchema
 dotnet ef database update
</span></code></pre></div>    </div>
  </li>
</ol>

<h3 id="add-the-authentication-middleware">Add the authentication middleware</h3>
<blockquote>
  <p>We need to ensure that the request pipeline contains the Authentication middleware before any other middleware that represents resources we want to potentially authorize, e.g. Razor Pages</p>
  <ol>
    <li>Open the <code class="highlighter-rouge">Startup.cs</code> file</li>
    <li>In the <code class="highlighter-rouge">Configure</code> method, add a call to add the Authentication middleware before the Authorization middleware:
``` c#
 public void Configure(IApplicationBuilder app, IHostingEnvironment env)
 {
     if (env.IsDevelopment())
     {
         app.UseDeveloperExceptionPage();
     }
     else
     {
         app.UseExceptionHandler(“/Error”);
         app.UseHsts();
     }</li>
  </ol>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    app.UseHttpsRedirection();
    app.UseStaticFiles();

    app.UseRouting();

    app.UseAuthentication();
    app.UseAuthorization();

    app.UseEndpoints(endpoints =&gt;
    {
        endpoints.MapRazorPages();
    });
}
```
</code></pre></div></div>

<h3 id="allow-creation-of-an-admin-user">Allow creation of an admin user</h3>
<blockquote>
  <p>Let’s make it so the site allows creation of an admin user when there isn’t one already. The first user to access the site will be deemed the administrator.</p>
</blockquote>

<ol>
  <li>Create a new class <code class="highlighter-rouge">AdminService</code> in the <code class="highlighter-rouge">Services</code> folder. This class will be responsible for managing the creation key generation and tracking whether the site should allow creating admin users.
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">class</span> <span class="nc">AdminService</span>
 <span class="p">{</span>
     <span class="k">private</span> <span class="k">readonly</span> <span class="n">IdentityDbContext</span> <span class="n">_dbContext</span><span class="p">;</span>

     <span class="k">private</span> <span class="kt">bool</span> <span class="n">_adminExists</span><span class="p">;</span>

     <span class="k">public</span> <span class="nf">AdminService</span><span class="p">(</span><span class="n">IdentityDbContext</span> <span class="n">dbContext</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">_dbContext</span> <span class="p">=</span> <span class="n">dbContext</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">AllowAdminUserCreationAsync</span><span class="p">()</span>
     <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">_adminExists</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">else</span>
         <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="k">await</span> <span class="n">_dbContext</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="nf">AnyAsync</span><span class="p">(</span><span class="n">user</span> <span class="p">=&gt;</span> <span class="n">user</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">))</span>
             <span class="p">{</span>
                 <span class="c1">// There are already admin users so disable admin creation</span>
                 <span class="n">_adminExists</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                 <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
             <span class="p">}</span>

             <span class="c1">// There are no admin users so enable admin creation</span>
             <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Extract an interface from the class and call it <code class="highlighter-rouge">IAdminService</code>
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">interface</span> <span class="nc">IAdminService</span>
 <span class="p">{</span>
     <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">AllowAdminUserCreationAsync</span><span class="p">();</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>In the <code class="highlighter-rouge">Startup</code> class, modify the <code class="highlighter-rouge">ConfigureServices</code> method to add the new service to the DI container:
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">IAdminService</span><span class="p">,</span> <span class="n">AdminService</span><span class="p">&gt;();</span>
</code></pre></div>    </div>
  </li>
</ol>

<blockquote>
  <p>We now need to override the default Register page to enable creating the admin account when the first user is registered.</p>
</blockquote>

<ol>
  <li>Run the Identity scaffolder again, but this time select the <code class="highlighter-rouge">Account\Register</code> page in the list of files to override and select the <code class="highlighter-rouge">IdentityDbContext (FrontEnd.Data)</code></li>
</ol>

<p><img src="/img/aspdotnetcore/confplanner/5/67.png" alt="" /></p>
<ul>
  <li>On command line, run
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet aspnet-codegenerator identity --dbContext FrontEnd.Data.IdentityDbContext --files Account.Register
</code></pre></div>    </div>
    <ol>
      <li>Update the <code class="highlighter-rouge">RegisterModel</code> class in the <code class="highlighter-rouge">Register.cshtml.cs</code> file to accept <code class="highlighter-rouge">IAdminService</code> as a parameter and it them to a local member:
        <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[</span><span class="n">AllowAnonymous</span><span class="p">]</span>
 <span class="k">public</span> <span class="k">class</span> <span class="nc">RegisterModel</span> <span class="p">:</span> <span class="n">PageModel</span>
 <span class="p">{</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">SignInManager</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">_signInManager</span><span class="p">;</span>        
<span class="k">private</span> <span class="k">readonly</span> <span class="n">UserManager</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">_userManager</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">RegisterModel</span><span class="p">&gt;</span> <span class="n">_logger</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">IEmailSender</span> <span class="n">_emailSender</span><span class="p">;</span>
<span class="k">private</span> <span class="k">readonly</span> <span class="n">IAdminService</span> <span class="n">_adminService</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">RegisterModel</span><span class="p">(</span>
    <span class="n">UserManager</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">userManager</span><span class="p">,</span>
    <span class="n">SignInManager</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">signInManager</span><span class="p">,</span>
    <span class="n">ILogger</span><span class="p">&lt;</span><span class="n">RegisterModel</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">,</span>
    <span class="n">IEmailSender</span> <span class="n">emailSender</span><span class="p">,</span>
    <span class="n">IAdminService</span> <span class="n">adminService</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_userManager</span> <span class="p">=</span> <span class="n">userManager</span><span class="p">;</span>
    <span class="n">_signInManager</span> <span class="p">=</span> <span class="n">signInManager</span><span class="p">;</span>
    <span class="n">_logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
    <span class="n">_emailSender</span> <span class="p">=</span> <span class="n">emailSender</span><span class="p">;</span>
    <span class="n">_adminService</span> <span class="p">=</span> <span class="n">adminService</span><span class="p">;</span>
<span class="p">}</span>

<span class="p">...</span>
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
</ul>

<ol>
  <li>Add code to the <code class="highlighter-rouge">OnPostAsync</code> that marks the new user as an admin if the <code class="highlighter-rouge">IAdminService.AllowAdminUserCreationAsync</code> returns true before creating the user:
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="k">await</span> <span class="n">_adminService</span><span class="p">.</span><span class="nf">AllowAdminUserCreationAsync</span><span class="p">())</span>
 <span class="p">{</span>
     <span class="c1">// Set as admin user</span>
     <span class="n">user</span><span class="p">.</span><span class="n">IsAdmin</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_userManager</span><span class="p">.</span><span class="nf">CreateAsync</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">Input</span><span class="p">.</span><span class="n">Password</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>Update the code that logs a message when users are created to indicate when an admin user is created:
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Admin user created a new account with password."</span><span class="p">);</span>
 <span class="p">}</span>
 <span class="k">else</span>
 <span class="p">{</span>
     <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"User created a new account with password."</span><span class="p">);</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<blockquote>
  <p>If you run the app at this point, you’ll see an exception stating that you can’t inject a scoped type into a type registered as a singleton. This is the DI system protecting you from a common anti-pattern that can arise when using IoC containers. Let’s fix the <code class="highlighter-rouge">AdminService</code> to use the scoped <code class="highlighter-rouge">IdentityDbContext</code> correctly.</p>
</blockquote>

<ol>
  <li>Open the <code class="highlighter-rouge">AdminService.cs</code> file and change the code to accept an <code class="highlighter-rouge">IServiceProvider</code> instead of the <code class="highlighter-rouge">IdentityDbContext</code> in its constructor:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">class</span> <span class="nc">AdminService</span> <span class="p">:</span> <span class="n">IAdminService</span>
 <span class="p">{</span>
     <span class="k">private</span> <span class="k">readonly</span> <span class="n">IServiceProvider</span> <span class="n">_serviceProvider</span><span class="p">;</span>

     <span class="k">private</span> <span class="kt">bool</span> <span class="n">_adminExists</span><span class="p">;</span>

     <span class="k">public</span> <span class="nf">AdminService</span><span class="p">(</span><span class="n">IServiceProvider</span> <span class="n">serviceProvider</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">_serviceProvider</span> <span class="p">=</span> <span class="n">serviceProvider</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="c1">// ...</span>
</code></pre></div>    </div>

    <p><img src="/img/aspdotnetcore/confplanner/5/68.png" alt="" /></p>
  </li>
  <li>Now update the <code class="highlighter-rouge">AllowAdminUserCreationAsync</code> method to create a service scope so we can ask for an instance of the <code class="highlighter-rouge">IdentityDbContext</code> within a scoped context:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">AllowAdminUserCreationAsync</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">_adminExists</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="k">else</span>
     <span class="p">{</span>
         <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="n">_serviceProvider</span><span class="p">.</span><span class="nf">CreateScope</span><span class="p">())</span>
         <span class="p">{</span>
             <span class="kt">var</span> <span class="n">dbContext</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">ServiceProvider</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IdentityDbContext</span><span class="p">&gt;();</span>

             <span class="k">if</span> <span class="p">(</span><span class="k">await</span> <span class="n">dbContext</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="nf">AnyAsync</span><span class="p">(</span><span class="n">user</span> <span class="p">=&gt;</span> <span class="n">user</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">))</span>
             <span class="p">{</span>
                 <span class="c1">// There are already admin users so disable admin creation</span>
                 <span class="n">_adminExists</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                 <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
             <span class="p">}</span>

             <span class="c1">// There are no admin users so enable admin creation</span>
             <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
         <span class="p">}</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Re-launch the application and now you shouldn’t get an exception.</li>
</ol>

<p><img src="/img/aspdotnetcore/confplanner/5/69.png" alt="" /></p>

<p><img src="/img/aspdotnetcore/confplanner/5/70.png" alt="" /></p>
<h1 id="adding-admin-section">Adding admin section</h1>

<h2 id="add-an-admin-policy">Add an admin policy</h2>
<blockquote>
  <p>Rather than looking up the user in the database each time the app needs to check if a user is an admin, we can read this information once when the user logs in, then store it as an additional claim on the user identity. We also need to add an authoriation policy to the app that corresponds to this claim, that we can use to protect resources we only want admins to be able to access.</p>
</blockquote>

<ol>
  <li>Add a new class <code class="highlighter-rouge">ClaimsPrincipalFactory</code> in the <code class="highlighter-rouge">/Areas/Identity</code> folder and add code that adds an admin claim for users who are admins:
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="k">class</span> <span class="nc">ClaimsPrincipalFactory</span> <span class="p">:</span> <span class="n">UserClaimsPrincipalFactory</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span>
 <span class="p">{</span>
     <span class="k">private</span> <span class="k">readonly</span> <span class="n">IApiClient</span> <span class="n">_apiClient</span><span class="p">;</span>

     <span class="k">public</span> <span class="nf">ClaimsPrincipalFactory</span><span class="p">(</span><span class="n">IApiClient</span> <span class="n">apiClient</span><span class="p">,</span> <span class="n">UserManager</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">userManager</span><span class="p">,</span> <span class="n">IOptions</span><span class="p">&lt;</span><span class="n">IdentityOptions</span><span class="p">&gt;</span> <span class="n">optionsAccessor</span><span class="p">)</span>
         <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">userManager</span><span class="p">,</span> <span class="n">optionsAccessor</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">_apiClient</span> <span class="p">=</span> <span class="n">apiClient</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ClaimsIdentity</span><span class="p">&gt;</span> <span class="nf">GenerateClaimsAsync</span><span class="p">(</span><span class="n">User</span> <span class="n">user</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="kt">var</span> <span class="n">identity</span> <span class="p">=</span> <span class="k">await</span> <span class="k">base</span><span class="p">.</span><span class="nf">GenerateClaimsAsync</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>

         <span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">)</span>
         <span class="p">{</span>
             <span class="n">identity</span><span class="p">.</span><span class="nf">MakeAdmin</span><span class="p">();</span>
         <span class="p">}</span>

         <span class="k">return</span> <span class="n">identity</span><span class="p">;</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Add a new class file <code class="highlighter-rouge">AuthHelpers.cs</code> in the <code class="highlighter-rouge">Infrastructure</code> folder and add the following helper methods for reading and setting the admin claim:
    <div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">namespace</span> <span class="nn">FrontEnd.Infrastructure</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">AuthConstants</span>
     <span class="p">{</span>
         <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">IsAdmin</span> <span class="p">=</span> <span class="k">nameof</span><span class="p">(</span><span class="n">IsAdmin</span><span class="p">);</span>
         <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">IsAttendee</span> <span class="p">=</span> <span class="k">nameof</span><span class="p">(</span><span class="n">IsAttendee</span><span class="p">);</span>
         <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">TrueValue</span> <span class="p">=</span> <span class="s">"true"</span><span class="p">;</span>
     <span class="p">}</span>
 <span class="p">}</span>

 <span class="k">namespace</span> <span class="nn">System.Security.Claims</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">AuthnHelpers</span>
     <span class="p">{</span>
         <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">IsAdmin</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsPrincipal</span> <span class="n">principal</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">principal</span><span class="p">.</span><span class="nf">HasClaim</span><span class="p">(</span><span class="n">AuthConstants</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">,</span> <span class="n">AuthConstants</span><span class="p">.</span><span class="n">TrueValue</span><span class="p">);</span>

         <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeAdmin</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsPrincipal</span> <span class="n">principal</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">principal</span><span class="p">.</span><span class="n">Identities</span><span class="p">.</span><span class="nf">First</span><span class="p">().</span><span class="nf">MakeAdmin</span><span class="p">();</span>

         <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">MakeAdmin</span><span class="p">(</span><span class="k">this</span> <span class="n">ClaimsIdentity</span> <span class="n">identity</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">identity</span><span class="p">.</span><span class="nf">AddClaim</span><span class="p">(</span><span class="k">new</span> <span class="nf">Claim</span><span class="p">(</span><span class="n">AuthConstants</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">,</span> <span class="n">AuthConstants</span><span class="p">.</span><span class="n">TrueValue</span><span class="p">));</span>
     <span class="p">}</span>
 <span class="p">}</span>

 <span class="k">namespace</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span>
 <span class="p">{</span>
     <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">AuthzHelpers</span>
     <span class="p">{</span>
         <span class="k">public</span> <span class="k">static</span> <span class="n">AuthorizationPolicyBuilder</span> <span class="nf">RequireIsAdminClaim</span><span class="p">(</span><span class="k">this</span> <span class="n">AuthorizationPolicyBuilder</span> <span class="n">builder</span><span class="p">)</span> <span class="p">=&gt;</span>
             <span class="n">builder</span><span class="p">.</span><span class="nf">RequireClaim</span><span class="p">(</span><span class="n">AuthConstants</span><span class="p">.</span><span class="n">IsAdmin</span><span class="p">,</span> <span class="n">AuthConstants</span><span class="p">.</span><span class="n">TrueValue</span><span class="p">);</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Register the custom <code class="highlighter-rouge">UserClaimsPrincipalFactory&lt;User&gt;</code> in the <code class="highlighter-rouge">IdentityHostingStartup</code> class:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">services</span><span class="p">.</span><span class="n">AddDefaultIdentity</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;()</span>
         <span class="p">.</span><span class="n">AddEntityFrameworkStores</span><span class="p">&lt;</span><span class="n">IdentityDbContext</span><span class="p">&gt;()</span>
         <span class="p">.</span><span class="n">AddClaimsPrincipalFactory</span><span class="p">&lt;</span><span class="n">ClaimsPrincipalFactory</span><span class="p">&gt;();</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add authorization services with an admin policy to the <code class="highlighter-rouge">ConfigureServices()</code> method of <code class="highlighter-rouge">Startup.cs</code> that uses the just-added helper methods to require the admin claim:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">services</span><span class="p">.</span><span class="nf">AddAuthorization</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
 <span class="p">{</span>
     <span class="n">options</span><span class="p">.</span><span class="nf">AddPolicy</span><span class="p">(</span><span class="s">"Admin"</span><span class="p">,</span> <span class="n">policy</span> <span class="p">=&gt;</span>
     <span class="p">{</span>
         <span class="n">policy</span><span class="p">.</span><span class="nf">RequireAuthenticatedUser</span><span class="p">()</span>
               <span class="p">.</span><span class="nf">RequireIsAdminClaim</span><span class="p">();</span>
     <span class="p">});</span>
 <span class="p">});</span>
</code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/71.png" alt="" /></p>
  </li>
  <li>
    <p>Add <code class="highlighter-rouge">System.Security.Claims</code> to the list of usings in <code class="highlighter-rouge">Index.cshtml.cs</code>, then use the helper method in the page model to determine if the current user is an administrator.</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAdmin</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

 <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnGetAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">day</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">IsAdmin</span> <span class="p">=</span> <span class="n">User</span><span class="p">.</span><span class="nf">IsAdmin</span><span class="p">();</span>

     <span class="c1">// More stuff here</span>
     <span class="c1">// ...</span>
 <span class="p">}</span>
</code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/72.png" alt="" /></p>
  </li>
  <li>
    <p>On the <code class="highlighter-rouge">Index</code> razor page, add an edit link to allow admins to edit sessions. You’ll add the following code directly after the session <code class="highlighter-rouge">foreach</code> loop:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"list-inline mb-0"</span><span class="nt">&gt;</span>
     @foreach (var speaker in session.Speakers)
     {
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"list-inline-item"</span><span class="nt">&gt;</span>
             <span class="nt">&lt;a</span> <span class="na">asp-page=</span><span class="s">"Speaker"</span> <span class="na">asp-route-id=</span><span class="s">"@speaker.Id"</span><span class="nt">&gt;</span>@speaker.Name<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
     }
     @if (Model.IsAdmin)
     {
         <span class="nt">&lt;li&gt;</span>
             <span class="nt">&lt;a</span> <span class="na">asp-page=</span><span class="s">"/Admin/EditSession"</span> <span class="na">asp-route-id=</span><span class="s">"@session.Id"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-xs"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
     }
     <span class="nt">&lt;/ul&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>Add a nested <code class="highlighter-rouge">Admin</code> folder to the <code class="highlighter-rouge">Pages</code> folder then add an <code class="highlighter-rouge">EditSession.cshtml</code> razor page and <code class="highlighter-rouge">EditSession.cshtml.cs</code> page model to it.</li>
  <li>
    <p>Next, we’ll protect pages in the <code class="highlighter-rouge">Admin</code> folder with an Admin policy by making the following change to the <code class="highlighter-rouge">services.AddRazorPages()</code> call in <code class="highlighter-rouge">Startup.ConfigureServices</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="nf">AddRazorPages</span><span class="p">(</span><span class="n">options</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">options</span><span class="p">.</span><span class="n">Conventions</span><span class="p">.</span><span class="nf">AuthorizeFolder</span><span class="p">(</span><span class="s">"/Admin"</span><span class="p">,</span> <span class="s">"Admin"</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/75.png" alt="" /></p>
  </li>
</ol>

<h2 id="add-a-form-for-editing-a-session">Add a form for editing a session</h2>
<ol>
  <li>
    <p>Change <code class="highlighter-rouge">EditSession.cshtml.cs</code> to render the session in the edit form:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">EditSessionModel</span> <span class="p">:</span> <span class="n">PageModel</span>
<span class="p">{</span>
   <span class="k">private</span> <span class="k">readonly</span> <span class="n">IApiClient</span> <span class="n">_apiClient</span><span class="p">;</span>

   <span class="k">public</span> <span class="nf">EditSessionModel</span><span class="p">(</span><span class="n">IApiClient</span> <span class="n">apiClient</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">_apiClient</span> <span class="p">=</span> <span class="n">apiClient</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">public</span> <span class="n">Session</span> <span class="n">Session</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

   <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">OnGetAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetSessionAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
      <span class="n">Session</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Session</span>
      <span class="p">{</span>
          <span class="n">Id</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
          <span class="n">TrackId</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">TrackId</span><span class="p">,</span>
          <span class="n">Title</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">Title</span><span class="p">,</span>
          <span class="n">Abstract</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">Abstract</span><span class="p">,</span>
          <span class="n">StartTime</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">StartTime</span><span class="p">,</span>
          <span class="n">EndTime</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">EndTime</span>
      <span class="p">};</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the “{id}” route to the <code class="highlighter-rouge">EditSession.cshtml</code> form:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> @page "{id}"
 @model EditSessionModel
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the following edit form to <code class="highlighter-rouge">EditSession.cshtml</code>:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h3&gt;</span>Edit Session<span class="nt">&lt;/h3&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">class=</span><span class="s">"form-horizontal"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">asp-validation-summary=</span><span class="s">"All"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Session.Id"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Session.TrackId"</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">asp-for=</span><span class="s">"Session.Title"</span> <span class="na">class=</span><span class="s">"col-md-2 control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-10"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Session.Title"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">asp-validation-for=</span><span class="s">"Session.Title"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">asp-for=</span><span class="s">"Session.Abstract"</span> <span class="na">class=</span><span class="s">"col-md-2 control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-10"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;textarea</span> <span class="na">asp-for=</span><span class="s">"Session.Abstract"</span> <span class="na">class=</span><span class="s">"form-control"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">asp-validation-for=</span><span class="s">"Session.Abstract"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">asp-for=</span><span class="s">"Session.StartTime"</span> <span class="na">class=</span><span class="s">"col-md-2 control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-10"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Session.StartTime"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">asp-validation-for=</span><span class="s">"Session.StartTime"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">asp-for=</span><span class="s">"Session.EndTime"</span> <span class="na">class=</span><span class="s">"col-md-2 control-label"</span><span class="nt">&gt;&lt;/label&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-10"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">asp-for=</span><span class="s">"Session.EndTime"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;span</span> <span class="na">asp-validation-for=</span><span class="s">"Session.EndTime"</span> <span class="na">class=</span><span class="s">"text-danger"</span><span class="nt">&gt;&lt;/span&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-md-offset-2 col-md-10"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">class=</span><span class="s">"btn btn-primary"</span><span class="nt">&gt;</span>Save<span class="nt">&lt;/button&gt;</span>
            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">asp-page-handler=</span><span class="s">"Delete"</span> <span class="na">class=</span><span class="s">"btn btn-danger"</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>

@section Scripts {
     <span class="nt">&lt;partial</span> <span class="na">name=</span><span class="s">"_ValidationScriptsPartial"</span> <span class="nt">/&gt;</span>
}
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add code to handle the <code class="highlighter-rouge">Save</code> and <code class="highlighter-rouge">Delete</code> button actions in <code class="highlighter-rouge">EditSession.cshtml.cs</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostAsync</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(!</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nf">Page</span><span class="p">();</span>
   <span class="p">}</span>

   <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">PutSessionAsync</span><span class="p">(</span><span class="n">Session</span><span class="p">);</span>

   <span class="k">return</span> <span class="nf">Page</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostDeleteAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetSessionAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">DeleteSessionAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nf">Page</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Add a <code class="highlighter-rouge">[BindProperty]</code> attribute to the <code class="highlighter-rouge">Session</code> property in <code class="highlighter-rouge">EditSession.cshtml.cs</code> to make sure properties get bound
on form posts:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">BindProperty</span><span class="p">]</span>
<span class="k">public</span> <span class="n">Session</span> <span class="n">Session</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>The form should be fully functional.</li>
</ol>

<h2 id="add-success-message-to-form-post-and-use-the-prg-pattern">Add success message to form post and use the <a href="https://en.wikipedia.org/wiki/Post/Redirect/Get">PRG</a> pattern</h2>

<ol>
  <li>
    <p>Add a <code class="highlighter-rouge">TempData</code> decorated <code class="highlighter-rouge">Message</code> property and a <code class="highlighter-rouge">ShowMessage</code> property to <code class="highlighter-rouge">EditSession.cshtml.cs</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">TempData</span><span class="p">]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="k">public</span> <span class="kt">bool</span> <span class="n">ShowMessage</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">Message</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Set a success message in the <code class="highlighter-rouge">OnPostAsync</code> and <code class="highlighter-rouge">OnPostDeleteAsync</code> methods and change <code class="highlighter-rouge">Page()</code> to <code class="highlighter-rouge">RedirectToPage()</code>:</p>

    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostAsync</span><span class="p">()</span>
<span class="p">{</span>
   <span class="k">if</span> <span class="p">(!</span><span class="n">ModelState</span><span class="p">.</span><span class="n">IsValid</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">return</span> <span class="nf">Page</span><span class="p">();</span>
   <span class="p">}</span>
      
   <span class="n">Message</span> <span class="p">=</span> <span class="s">"Session updated successfully!"</span><span class="p">;</span>

   <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">PutSessionAsync</span><span class="p">(</span><span class="n">Session</span><span class="p">);</span>

   <span class="k">return</span> <span class="nf">RedirectToPage</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IActionResult</span><span class="p">&gt;</span> <span class="nf">OnPostDeleteAsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
   <span class="kt">var</span> <span class="n">session</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">GetSessionAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
   <span class="p">{</span>
       <span class="k">await</span> <span class="n">_apiClient</span><span class="p">.</span><span class="nf">DeleteSessionAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
   <span class="p">}</span>
      
   <span class="n">Message</span> <span class="p">=</span> <span class="s">"Session deleted successfully!"</span><span class="p">;</span>

   <span class="k">return</span> <span class="nf">RedirectToPage</span><span class="p">(</span><span class="s">"/Index"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/77.png" alt="" /></p>
  </li>
</ol>

<p><img src="/img/aspdotnetcore/confplanner/5/78.png" alt="" /></p>
<ol>
  <li>
    <p>Update <code class="highlighter-rouge">EditSession.cshtml</code> to show the message after posting. Add the following code directly below the <code class="highlighter-rouge">&lt;h3&gt;</code> tag at the top:</p>

    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@if (Model.ShowMessage)
{
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-success alert-dismissible"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"Close"</span><span class="nt">&gt;&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;</span>   <span class="nt">&lt;/button&gt;</span>
        @Model.Message
    <span class="nt">&lt;/div&gt;</span>
}
</code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/79.png" alt="" /></p>
    <blockquote>
      <p>TempData-backed properties also flow across pages, so we can update the Index page to show the message value too, e.g. when the session is deleted</p>
    </blockquote>
  </li>
  <li>Copy the message display markup from the top of the <code class="highlighter-rouge">EditSession.cshtml</code> file to the top of the <code class="highlighter-rouge">Index.cshtml</code> file:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> @if (Model.ShowMessage)
 {
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-success alert-dismissible"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"Close"</span><span class="nt">&gt;&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;</span>   <span class="nt">&lt;/button&gt;</span>
         @Model.Message
     <span class="nt">&lt;/div&gt;</span>
 }
</code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/80.png" alt="" /></p>
  </li>
  <li>Copy the properties from the <code class="highlighter-rouge">EditSession.cshtml.cs</code> Page Model class file to the <code class="highlighter-rouge">Index.cshtml.cs</code> Page Model too:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[</span><span class="n">TempData</span><span class="p">]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="k">public</span> <span class="kt">bool</span> <span class="n">ShowMessage</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">Message</span><span class="p">);</span>
</code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/81.png" alt="" /></p>
  </li>
  <li>Rebuild and run the app then delete a session and observe it redirect to the home page and display the success message</li>
</ol>

<h2 id="create-a-tag-helper-for-setting-authorization-requirements-for-ui-elements">Create a Tag Helper for setting authorization requirements for UI elements</h2>
<p>We’re currently using <code class="highlighter-rouge">if</code> blocks to determine whether to show parts of the UI based the user’s auth policies. We can clean up this code by creating a custom <a href="https://docs.microsoft.com/en-us/aspnet/core/mvc/views/tag-helpers/intro">Tag Helper</a>.</p>

<ol>
  <li>Create a new folder called <code class="highlighter-rouge">TagHelpers</code> in the root of the <em>FrontEnd</em> project. Right-click on the folder, select <em>Add</em> / <em>New Item…</em> / <em>Razor Tag Helper</em>. Name the Tag Helper <code class="highlighter-rouge">AuthzTagHelper.cs</code>.</li>
  <li>Modify the <code class="highlighter-rouge">HtmlTargetElement</code> attribute to bind to all elements with an “authz” attribute:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">HtmlTargetElement</span><span class="p">(</span><span class="s">"*"</span><span class="p">,</span> <span class="n">Attributes</span> <span class="p">=</span> <span class="s">"authz"</span><span class="p">)]</span>
</code></pre></div>    </div>
  </li>
  <li>Add an additional <code class="highlighter-rouge">HtmlTargetElement</code> attribute to bind to all elements with an “authz-policy” attribute:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">HtmlTargetElement</span><span class="p">(</span><span class="s">"*"</span><span class="p">,</span> <span class="n">Attributes</span> <span class="p">=</span> <span class="s">"authz-policy"</span><span class="p">)]</span>
</code></pre></div>    </div>
  </li>
  <li>Inject the <code class="highlighter-rouge">AuthorizationService</code> as shown:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">readonly</span> <span class="n">IAuthorizationService</span> <span class="n">_authzService</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">AuthzTagHelper</span><span class="p">(</span><span class="n">IAuthorizationService</span> <span class="n">authzService</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_authzService</span> <span class="p">=</span> <span class="n">authzService</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Add the following properties which will represent the <code class="highlighter-rouge">auth</code> and <code class="highlighter-rouge">authz</code> attributes we’re binding to:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">HtmlAttributeName</span><span class="p">(</span><span class="s">"authz"</span><span class="p">)]</span>
<span class="k">public</span> <span class="kt">bool</span> <span class="n">RequiresAuthentication</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="p">[</span><span class="nf">HtmlAttributeName</span><span class="p">(</span><span class="s">"authz-policy"</span><span class="p">)]</span>
<span class="k">public</span> <span class="kt">string</span> <span class="n">RequiredPolicy</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Add a <code class="highlighter-rouge">ViewContext</code> property:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">ViewContext</span><span class="p">]</span>
<span class="k">public</span> <span class="n">ViewContext</span> <span class="n">ViewContext</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Mark the <code class="highlighter-rouge">ProcessAsync</code> method as <code class="highlighter-rouge">async</code>.</li>
  <li>Add the following code to the <code class="highlighter-rouge">ProcessAsync</code> method:
    <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ProcessAsync</span><span class="p">(</span><span class="n">TagHelperContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">TagHelperOutput</span> <span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">requiresAuth</span> <span class="p">=</span> <span class="n">RequiresAuthentication</span> <span class="p">||</span> <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">RequiredPolicy</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">showOutput</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">AllAttributes</span><span class="p">[</span><span class="s">"authz"</span><span class="p">]</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">requiresAuth</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">ViewContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// authz="false" &amp; user isn't authenticated</span>
        <span class="n">showOutput</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">RequiredPolicy</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// authz-policy="foo" &amp; user is authorized for policy "foo"</span>
        <span class="kt">var</span> <span class="n">authorized</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">cachedResult</span> <span class="p">=</span> <span class="n">ViewContext</span><span class="p">.</span><span class="n">ViewData</span><span class="p">[</span><span class="s">"AuthPolicy."</span> <span class="p">+</span> <span class="n">RequiredPolicy</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cachedResult</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">authorized</span> <span class="p">=</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="n">cachedResult</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">authResult</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_authzService</span><span class="p">.</span><span class="nf">AuthorizeAsync</span><span class="p">(</span><span class="n">ViewContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">User</span><span class="p">,</span> <span class="n">RequiredPolicy</span><span class="p">);</span>
            <span class="n">authorized</span> <span class="p">=</span> <span class="n">authResult</span><span class="p">.</span><span class="n">Succeeded</span><span class="p">;</span>
            <span class="n">ViewContext</span><span class="p">.</span><span class="n">ViewData</span><span class="p">[</span><span class="s">"AuthPolicy."</span> <span class="p">+</span> <span class="n">RequiredPolicy</span><span class="p">]</span> <span class="p">=</span> <span class="n">authorized</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">showOutput</span> <span class="p">=</span> <span class="n">authorized</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">requiresAuth</span> <span class="p">&amp;&amp;</span> <span class="n">ViewContext</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">User</span><span class="p">.</span><span class="n">Identity</span><span class="p">.</span><span class="n">IsAuthenticated</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// authz="true" &amp; user is authenticated</span>
        <span class="n">showOutput</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(!</span><span class="n">showOutput</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">output</span><span class="p">.</span><span class="nf">SuppressOutput</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>Register the new Tag Helper in the <code class="highlighter-rouge">_ViewImports.cshtml</code> file:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@namespace FrontEnd.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@addTagHelper *, FrontEnd
</code></pre></div>    </div>
  </li>
  <li>We can now update the <code class="highlighter-rouge">Index.cshtml</code> page to replace the <code class="highlighter-rouge">if</code> block which controls the Edit button’s display with declarative code using our new Tag Helper. Remove the <code class="highlighter-rouge">if</code> block and add <code class="highlighter-rouge">authz="true</code> to the <code class="highlighter-rouge">&lt;a&gt;</code> which displays the edit button:
    <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-footer"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"list-inline mb-0"</span><span class="nt">&gt;</span>
     @foreach (var speaker in session.Speakers)
     {
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"list-inline-item"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;a</span> <span class="na">asp-page=</span><span class="s">"Speaker"</span> <span class="na">asp-route-id=</span><span class="s">"@speaker.Id"</span><span class="nt">&gt;</span>@speaker.Name<span class="nt">&lt;/a&gt;</span>
         <span class="nt">&lt;/li&gt;</span>
     }
     <span class="nt">&lt;/ul&gt;</span>
     <span class="nt">&lt;a</span> <span class="na">authz-policy=</span><span class="s">"Admin"</span> <span class="na">asp-page=</span><span class="s">"/Admin/EditSession"</span> <span class="na">asp-route-id=</span><span class="s">"@session.Id"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-xs"</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
</code></pre></div>    </div>
    <p><img src="/img/aspdotnetcore/confplanner/5/83.png" alt="" /> 
 <img src="/img/aspdotnetcore/confplanner/5/85.png" alt="" /> 
 <img src="/img/aspdotnetcore/confplanner/5/86.png" alt="" />
 <img src="/img/aspdotnetcore/confplanner/5/87.png" alt="" />
 <img src="/img/aspdotnetcore/confplanner/5/88.png" alt="" />
 <img src="/img/aspdotnetcore/confplanner/5/89.png" alt="" />
 <img src="/img/aspdotnetcore/confplanner/5/90.png" alt="" />
 <img src="/img/aspdotnetcore/confplanner/5/91.png" alt="" />
 <img src="/img/aspdotnetcore/confplanner/5/92.png" alt="" /></p>
  </li>
</ol>

<hr />
<h2 id="sessions">Sessions</h2>

<p>This is series of articles on Building Conf planner app with Asp.net Core:</p>

<ul>
  <li><a href="/blog/CreateBackEndAPIproject" target="_blank">1 - Build the back-end API with basic EF model</a></li>
  <li><a href="/blog/BuildoutBackEndandRefactor" target="_blank">2 - Finish the back-end API and EF model, refactor into view modelsl</a></li>
  <li><a href="/blog/Addfront-endrenderagendasetupfront-endmodels" target="_blank">3 - Add front-end, render agenda, set up front-end models</a></li>
  <li><a href="/blog/Addauthfeatures" target="_blank">4 - Add authentication, add admin policy, allow editing sessions, users can sign-in with Identity, custom auth tag helper</a></li>
  <li><a href="/blog/Addpersonalagenda" target="_blank">5 - Add user association and personal agenda</a></li>
  <li><a href="/blog/ProductionReadinessandDeployment" target="_blank">6 - Deployment, Azure and other production environments, configuring environments, diagnostics</a></li>
  <li><a href="/blog/Challenges" target="_blank">7 - Challenges</a></li>
  <li><a href="/blog/SPAFrontEnd" target="_blank">8 - SPA front-end </a></li>
</ul>

<!--Section: Lesson UI-->
<section class="text-center">
    <hr />
   
    <div class="row">
        <div class="col-lg-4 col-md-6 col-sm-6">
            <a target="_blank" href="/blog/Addfront-endrenderagendasetupfront-endmodels" class="btn  btn-sm" id="round-button">
                <i class="fas fa-arrow-left mr-2"></i>Previous Lesson
            </a>
        </div>
     
        <div class="col-lg-4 col-md-6 col-sm-6">
            <a target="_blank" href="/blog/Addpersonalagenda" class="btn btn-sm" id="round-button">Next Lesson
                <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>       
    </div>

</section>


                </div>

                

                <div id="disqus_thread"></div>
                <script>
                
                /**
                *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
                /*
                var disqus_config = function () {
                this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };
                */
                (function() { // DON'T EDIT BELOW THIS LINE
                var d = document, s = d.createElement('script');
                s.src = 'https://girishgodage-github-io.disqus.com/embed.js';
                s.setAttribute('data-timestamp', +new Date());
                (d.head || d.body).appendChild(s);
                })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



            </div>
        </div>
    </div>
    <!-- Go To Top-->
<button onclick="topFunction()"
id="myBtn"
title="Go to top"> <i class="fa fa-chevron-up"  style="font-size:36px"></i>
</button>
<!-- Footer-->
<footer class="main-footer">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 text-center text-lg-left">
                <p class="social">
                    <a href="https://www.facebook.com/girish.godage.5" class="external facebook wow fadeInUp">
                        <i class="fa fa-facebook"></i></a>
                    <a href="https://instagram.com/girishgodage_007" data-wow-delay="0.2s" class="external instagram wow fadeInUp">
                        <i class="fa fa-instagram"></i></a>
                    <a href="https://youtube.com/girishgodage" data-wow-delay="0.4s" class="external youtube wow fadeInUp">
                        <i class="fa fa-youtube-play"></i></a>
                    <a href="https://twitter.com/GGodage" data-wow-delay="0.4s" class="external twitter wow fadeInUp">
                            <i class="fa fa-twitter"></i></a>
                    <a href="https://github.com/girishgodage" data-wow-delay="0.4s" class="external github wow fadeInUp">
                                <i class="fa fa-github"></i></a>    
                    <a href="mailto:girishgodage@gmail.com?subject=Hello%20Girish" data-wow-delay="0.6s" class="email wow fadeInUp">
                        <i class="fa fa-envelope"></i></a></p>
            </div>
            <div class="col-12 col-md-2">
            <h5>Quick Links</h5>
            <ul>
               <li><a href="http://localhost:4000#about">About</a></li>
               <li><a href="http://localhost:4000#contact">Contact</a></li>
               <li><a href="http://localhost:4000/sitemap.xml">Sitemap</a></li>               
            </ul>
         </div>
            <div class="col-12 col-md-4 text-center text-lg-right mt-4 mt-lg-0">
                <p> <b>©</b>2019 Girish Godage </p>
                <p class="text-center, text-shadow"> Hosted On <a href="https://pages.github.com/">GitHub Pages</a></p>
            </div>
        </div>
    </div>
</footer>
    <!-- Typed.js DONT TOUCH THIS! -->
    <div id="typed-strings">
    </div>

        <!-- JavaScript files-->
    <script src="http://localhost:4000/sitejs/jquery/jquery.min.js"></script>
    <script src="http://localhost:4000/sitejs/popper.js/umd/popper.min.js"> </script>
    <script src="http://localhost:4000/sitejs/bootstrap/js/bootstrap.min.js"></script>
    <script src="http://localhost:4000/sitejs/jquery.cookie/jquery.cookie.js"> </script>
    <script src="http://localhost:4000/sitejs/owl.carousel/owl.carousel.min.js"></script>
    <script src="http://localhost:4000/sitejs/waypoints/lib/jquery.waypoints.min.js"></script>
    <script src="http://localhost:4000/sitejs/jquery.counterup/jquery.counterup.js"></script>
    <script src="http://localhost:4000/js/front.js"></script>
    <script src="http://localhost:4000/js/comment.js"></script>
       <!-- Script pointing to search-script.js -->
    <script src="http://localhost:4000/js/search-script.js" type="text/javascript"></script>
   
    <!-- Configuration -->
    <script>
         SimpleJekyllSearch({
         searchInput: document.getElementById('search-input'),
         resultsContainer: document.getElementById('results-container'),
         json: 'http://localhost:4000/search.json'
         })
         </script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-analytics.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyC36FUDDdOTidZJ8nzS5vfE7KVyayenKPE",
    authDomain: "githubcontactlist.firebaseapp.com",
    databaseURL: "https://githubcontactlist.firebaseio.com",
    projectId: "githubcontactlist",
    storageBucket: "githubcontactlist.appspot.com",
    messagingSenderId: "899685398702",
    appId: "1:899685398702:web:0c23c56d2d6d40df37553f",
    measurementId: "G-YWBRCYJYFW"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
</script>
<script>
   $(function() {
      
    //make a variable to keep track of data coming from firebase
    var data = [];

    // Reference messages collection
      var messagesRef = firebase.database().ref('contactformmessages');  


    //listen to data updates from firebase
    messagesRef.on("value", function(snapshot) {
        console.log(snapshot.val());
        //when the data updates at firebase, put it in the data variable
        data = snapshot.val();
    })
    //Entire Contact Form (handler)
    $('#contactForm').submit(function(e) {
      e.preventDefault();

        var $form = $(this);
        console.log("Submit to Firebase");

        //disable submit button
        $form.find("#sendForm").prop('disabled', true);

        //get values to send to Firebase
        var name = $('#name').val();
        console.log(name);
		
		var surname = $('#surname').val();
        console.log(surname);
		
		var email = $('#email').val();
        console.log(email);	
		
		var phone = $('#phone').val();
        console.log(phone);

        var message = $('#message').val();
        console.log(message);

       
        //take the values from the form, and put them in an object
        var newContact = {
         "name": name,
			"surname": surname,
			"email": email,
			"phone": phone,
         "message": message
        }
        //put new object in data array
        data.push(newContact);
        console.log(data);

        //send the new data to Firebase
        messagesRef.set(data, function(err) {
            if (err) {
                alert("Data no go");
            }else{
            $("#form-wrapper").slideToggle();
            $('#form-success-message').slideToggle();
			}
        });

        return false;
    })
   
    
})
</script>

<script>

    function disableScrolling() {
        let x = window.scrollX;
        let y = window.scrollY;
        window.onscroll = function () { window.scrollTo(x, y); };
    }

    function enableScrolling() {
        window.onscroll = function () { };
    }

    // Add copy button
    let pres = document.getElementsByTagName('pre');
    Array.from(pres).forEach((element2) => {
        let element = document.createElement('button');
        element.setAttribute('class', 'btn btn-primary');
        element.innerHTML = 'Copy';
        element.style.float = 'right';

        element.addEventListener('click', (e) => {
            disableScrolling();
            console.log(e)
            let x = window.screenX;
            let y = window.screenY;

            element.innerHTML = 'copied';
            let tarea = document.createElement('textarea');
            tarea.innerHTML = element.parentElement.children[1].innerText;
            document.body.append(tarea);
            tarea.focus();
            tarea.select();
            document.execCommand('copy');
            tarea.style.display = 'none';
            setTimeout(() => {
                element.innerHTML = 'Copy';
            }, 2000);
            setTimeout(() => {
                enableScrolling();
            }, 0);
        })
        element2.insertBefore(element, element2.children[0]);
    })

    //Get the button
    myBtton = document.getElementById("myBtn");
    window.onscroll=function()
    {
        scrollFunction();
    }
    function scrollFunction(){
        if (document.body.scrollTop > 20 ||
        document.documentElement.scrollTop >20)
        {
            myBtton.style.display="block";           
        }else
        {
           myBtton.style.display="none";     
          
        }
    }
    //When user click on the top button
    function topFunction(){
      //  document.body.scrollTop =0;
      //  document.documentElement.scrollTop=0;
        $("html, body").animate({
            scrollTop: 0
        }, 600);
        return false;
    }

</script>

    
    


</body>

</html>